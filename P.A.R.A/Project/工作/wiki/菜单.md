# 菜单

## 右键菜单
### 背景：
富文本编辑器预览时期望提供右键复制功能。

### 复制功能实现方法分析
- 旧版浏览器：document.execCommand('copy')
- 现代 Clipboard API
- ctrl + c

### 思路
是否能在用户点击复制按钮时，程序调用ctrl + C，达到触发浏览器复制操作？
- 不能直接用程序模拟 Ctrl + C 操作。出于安全原因，浏览器不允许 JS 代码直接触发 “Ctrl + C”这种全局快捷键事件。即使用 `document.execCommand('copy')` 或 `Clipboard API`，也只是调用复制操作，而不是模拟键盘事件。
- 可以调用复制API，但不能“伪造”一个Ctrl + C事件让浏览器自动处理。

**如何实现‘像 Ctrl + C 一样’复制富文本内容**
- 关键是复制选区的富文本内容，包括图片、格式等。
- Clipboard API

```
const handleCopy = async () => {
  try {
    // 获取选中的内容
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0) {
      return;
    }
    
    // 创建一个包含HTML和纯文本的ClipboardItem
    const range = selection.getRangeAt(0);
    const html = range.cloneContents();
    const div = document.createElement('div');
    div.appendChild(html.cloneNode(true));
    
    const text = selection.toString();
    const htmlContent = div.innerHTML;

    console.log(39, text, htmlContent);
    
    // 使用Clipboard API写入富文本和纯文本
    const clipboardItem = new ClipboardItem({
      'text/html': new Blob([htmlContent], { type: 'text/html' }),
      'text/plain': new Blob([text], { type: 'text/plain' })
    });
    
    await navigator.clipboard.write([clipboardItem]);
  } catch (err) {
    console.error('Failed to copy:', err);
    // 降级方案：使用document.execCommand
    document.execCommand('copy');
  }
};

```

### 遇到的问题
这样实现后发现无论复制富文本还是纯文本，粘贴时内容都是空的。排查后发现虽然浏览器支持Clipboard，但是39行输出的text、htmlContent均为空。将该现象与AI交流后给出了如下反馈：
核心问题：
- 期望右键菜单点击“复制”时，能像Ctrl + C 一样复制富文本（含图片）
- 但发现此时**`window.getSelection()`获取到的选区内容为空**，导致复制的text、html都是空的。
- 用`navigation.clipboard.writeText(text)`能正常复制，说明 Clipboard API 没问题，**问题在于选区**。 这里的 text 是在 click 事件中提前保存了

#### 整理问题
按上述代码实现后发现无论复制富文本还是纯文本，粘贴时内容都是空的。排查后发现此时**`window.getSelection()`获取到的选区内容为空**，导致复制的text、html都是空的。用`navigation.clipboard.writeText(text)`能正常复制，说明 Clipboard API 没问题，**问题在于选区内容为空**


### 关键原因
右键菜单弹出时，浏览器通常会清除或改变当前选区，导致在点击菜单项时再去获取选区，已经没有内容了。


### 解决思路
**在用户点击右键时保存选区**
- 在 `oncontextmenu`(右键)事件时，立即保存当前选区A
- 在点击“复制”按钮时，从保存的选区A中获取选区内容。
```
let lastSelection: Range | null = null;

document.addEventListener('oncontextmenu', () => {
  // 当前选区
  const selection = window.getSelection();
  if (selection && selection.rangeCount > 0) {
    // 当前选区的range对象
    lastSelection = selection.getRangeAt(0).cloneRange()
  }
})

const copyToClipboard = async () => {
  try {
    if (!lastSelection) {
      return;
    }
    
    // 创建一个包含HTML和纯文本的ClipboardItem
    const range = lastSelection;
    const html = range.cloneContents();
    const div = document.createElement('div');
    div.appendChild(html.cloneNode(true));
    
    const text = lastSelection.toString();
    const htmlContent = div.innerHTML;
    
    // 使用Clipboard API写入富文本和纯文本
    const clipboardItem = new ClipboardItem({
      'text/html': new Blob([htmlContent], { type: 'text/html' }),
      'text/plain': new Blob([text], { type: 'text/plain' })
    });
    
    await navigator.clipboard.write([clipboardItem]);
  } catch (err) {
    console.error('Failed to copy:', err);
    // 降级方案：使用document.execCommand
    document.execCommand('copy');
  }
}
```

