# 附件上传位置错误

## 现象描述

增加了自动保存功能后，在编辑器点击任意位置上传附件时，附件只能上传到文件末尾。但期望附件上传到当前鼠标所在的位置。

## 思考

1. 未加自动保存前，附件可以正确上传到鼠标所在位置。上传时是如何正确获取编辑器状态的，为什么增加了自动保存后不能获取了。
2. 自动保存时调用的方法后编辑器发生了什么变化？
3. 是否可以在保存前先存下当前的选区信息？

## 分析

上传附件点击确定的函数中，在 editor.update 使用 `$insertNodes()` 将插件节点插入当前选区位置。加入自动保存功能后，上传附件的回调中选区信息丢失了，导致附件上传到了最后。

为什么自动保存会导致编辑器选区信息丢失？自动保存调用了获取编辑器块信息（json）的方法，可能会在附件插入过程中干扰编辑器的选择状态。

## 解决思路

在监控到选区变化时，将选区信息保存下来。在执行附件插入前，如果编辑器的选区丢失，则先恢复编辑器的选区再执行附件插入操作。
并在上传附件开始前，先将自动保存功能暂停，待上传附件结束时，再恢复

### 改动

1. 保存编辑器的选区

```
...
const { setActiveSelection } = useActiveSelectionStore();
useEffect(() => {
  return editor.registerCommand(
    SELECTION_CHANGE_COMMAND,
    (_payload, newEditor) => {
      ...
      setActiveSelection($getSelection());
      return false;
    },
    COMMAND_PRIORITY_CRITICAL,
  )
}, [editor, $updateToolbar])
```

2. 在插入附件前，先恢复选区

```
const { activeSelection } = useActiveSelectionStore();
const handleInsertNode = () => {
  editor.update(() => {
    const select = $getSelection();
    if (!select && activeSelection) {
      $setSelection(select)
    }

    ...
    $insertNodes([node])
  }, [editor])
}
```

3. 在上传附件前先暂停自动保存功能，在上传附件结束后恢复自动保存功能

```
const showModal = () => {
  window.dispatchEvent(new CustomEvent('pauseAutoSave'));
}

const onClose = () => {
  window.dispatchEvent(new CustomEvent('resumeAutoSave'));
}


// autoSave 组件
useEffect(() => {
  if(timer.current) {
    clearInterval(timer.current);
    timer.current = null;
  }
  timer.current = setInterval(autoSave, 3000);

  const handlePauseAutoSave = () => {
    if (timer.current) {
      clearInterval(timer.current);
      timer.current = null;
    }
  }

  const handleResumeAutoSave = () => {
    timer.current = setInterval(autoSave, 3000);
  }

  window.addEventListener('pauseAutoSave', handlePauseAutoSave);
  window.addEventListener('resumeAutoSave', handleResumeAutoSave);

  return () => {
    if (timer.current) {
      clearInterval(timer.current);
      timer.current = null;
    }
    window.removeEventListener('pauseAutoSave', handlePauseAutoSave);
    window.removeEventListener('resumeAutoSave', handleResumeAutoSave);
  }
}, [])
```
