# 什么是埋点

埋点指在应用程序或网站中植入代码，用于收集用户行为数据、性能指标等信息的监控技术。通过埋点可以获取：

- 用户行为（点击、滚动、页面停留等）
- 性能数据（页面加载时间、接口响应时间等）
- 错误信息（JS 错误、API 失败等）
- 业务数据（转化率、购买行为等）

**埋点完整业务流程：**

1. 初始化流程

```
const tracker = new Tracker({
  ...,// 初始配置信息
})
```

2. 埋点类型和触发方式

a. DOM 点击埋点

```
// 通过HTML属性标记
<button data-track-click='{"action": "click_submit", "type": "button_click"}'>提交</button>

// 全局点击监听（热力图）
if (this._options.enableHeatMapTrackerFlag) {
  this.__openInnerTrack(['click'], 'innerHeatMap')
}
```

b. 页面加载埋点

```
if (this._options.enableLoadTracker) {
  this.__openInnerTrack(['load'], 'innerPageLoad')
}
```

c. 路由变化

```
// SPA应用路由监听
if (this._options.enableHistoryTracker) {
  history.pushState = createHistoryEvent('')
}

// hash路由监听
if (this._options.enableHashTracker){
  this._openInnerTack(['hashchange'], 'innerHashChange')
}
```

3. 数据收集和处理流程
   a. 事件触发

```
_captureEvents(eventList, trackKey) {
  window[eventMethodObj.addMethod](eventMethod.prefix + eventName,
  (event) => {
    // 1. 获取事件信息
    const eventFix = getEvent(event)
    // 2. 节流处理
    if (now - previous > that.delay) {
      // 3. 收集数据
      const domData = that.__getDomAndOffset(eventFix, reportKey)
      // 4. 发送数据
      that.senTracker(domData)
    }
  }
)
}
```

b. 数据组装

```
sendTracker(data = {}) {
  // 1. 合并基础信息
  const sendData = merge(
    getAppInfo(extra?.platform), // 设备、浏览器信息
    extra, // 用户配置的额外信息
    data // 事件数据
  )
}
```

4. 数据上报流程

```
xmlHttpRequest(url, data, query, tracker) {
  // 1. 发送请求
  const client = new XMLHttpRequest()
  client.setRequestHeader('Authorization', `Bearer ${query?.token}`)

  //2. Token 失效重试处理
  client.onreadystatechange = async function(){

  }


}
```

- 发送请求
- 处理认证
- 失败重试
- 列队管理

5. 数据分析阶段

- 数据存储
- 数据分析
- 生成报表
- 指标监控
